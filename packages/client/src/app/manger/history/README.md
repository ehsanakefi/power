# تاریخچه تیکت‌های واگذار شده - Manager History Page

این صفحه برای مدیران طراحی شده است تا بتوانند تاریخچه و فعالیت‌های مربوط به تیکت‌هایی که مستقیماً به آنها واگذار شده‌اند را مشاهده کنند.

## فیلترینگ خودکار
⚠️ **نکته مهم**: این صفحه فقط تاریخچه فعالیت‌هایی را نمایش می‌دهد که مربوط به تیکت‌های واگذار شده به کاربر فعلی است (`assignedToUserId = currentUser.id`).

## ویژگی‌های اصلی

### 1. نمایش اطلاعات کاربر
- نمایش نام کاربر فعلی در هدر صفحه
- کارت اطلاعاتی آبی توضیح‌دهنده فیلترینگ
- نمایش وضعیت استفاده از داده‌های نمونه

### 2. آمار فعالیت‌های واگذار شده
- کل فعالیت‌های ثبت شده
- تعداد تغییرات وضعیت
- تعداد نظرات افزوده شده
- تعداد کاربران فعال

### 3. فیلترینگ و جستجو
- جستجو در عنوان تیکت، شناسه، نام کاربر و جزئیات
- فیلتر بر اساس نوع عملیات:
  - ایجاد شده
  - تغییر وضعیت
  - واگذاری
  - نظر افزوده شد
  - فایل پیوست شد
  - به‌روزرسانی شد

- فیلتر بر اساس کاربر انجام‌دهنده
- فیلتر بر اساس تیکت خاص

### 4. نمایش تاریخچه (Timeline)
هر فعالیت شامل:
- آیکون رنگی مناسب با نوع عملیات
- عنوان تیکت و شناسه
- کاربر انجام‌دهنده عمل
- زمان انجام (تاریخ و ساعت)
- جزئیات تغییرات (قبل/بعد)
- نظرات اضافه شده (در صورت وجود)
- Timeline خطی برای نمایش تسلسل زمانی

### 5. انواع فعالیت‌ها
- **ایجاد شده**: تیکت جدید ایجاد شد
- **تغییر وضعیت**: وضعیت تیکت تغییر کرد
- **واگذاری**: تیکت به کاربر جدید واگذار شد
- **نظر افزوده شد**: نظر یا توضیح جدید اضافه شد
- **فایل پیوست شد**: مدرک یا فایل ضمیمه شد
- **به‌روزرسانی شد**: سایر تغییرات در تیکت

## استفاده از API

این صفحه از APIهای زیر استفاده می‌کند:
- `getUserProfile()` - دریافت اطلاعات کاربر فعلی
- `HistoryService.getAllHistory({ assignedToUserId: currentUser.id })` - دریافت تاریخچه با فیلتر خودکار
- `HistoryService.getHistoryStats()` - دریافت آمار فعالیت‌ها

### فیلتر خودکار assignedToUserId
صفحه به صورت خودکار پارامتر `assignedToUserId: currentUser.id` را به درخواست API اضافه می‌کند تا فقط تاریخچه تیکت‌های واگذار شده به کاربر فعلی دریافت شود.

## رنگ‌بندی انواع فعالیت

- **ایجاد شده**: آبی (#2563eb)
- **تغییر وضعیت**: نارنجی (#d97706)
- **واگذاری**: بنفش (#9333ea)
- **نظر افزوده شد**: سبز (#16a34a)
- **فایل پیوست شد**: بنفش تیره (#4338ca)
- **به‌روزرسانی شد**: خاکستری (#4b5563)

## ویژگی‌های تکنیکی

### State Management
- استفاده از React Hooks برای مدیریت state
- مدیریت `currentUser` برای فیلترینگ خودکار
- Real-time filtering برای جستجو و فیلترها
- Loading states برای UX بهتر

### Timeline Design
- ScrollArea با ارتفاع محدود برای عملکرد بهتر
- Cards برای هر فعالیت
- خط‌های اتصال برای نمایش تسلسل زمانی
- Responsive design برای موبایل و دسکتاپ

### Error Handling
- Fallback به mock data در صورت خطا در API
- Mock data شامل فعالیت‌های واقع‌گرایانه برای تیکت‌های واگذار شده
- نمایش پیام‌های خطا با toast
- مدیریت حالات loading و error

### Accessibility
- پشتیبانی از RTL
- کیبورد navigation
- ARIA labels مناسب
- رنگ‌بندی قابل تشخیص
- ScrollArea برای محتوای طولانی

## مسیر API Backend

در فایل `power/packages/server/src/routes/history.ts` پارامتر `assignedToUserId` اضافه شده است:

```javascript
query('assignedToUserId')
  .optional()
  .isInt({ min: 1 })
  .withMessage('شناسه کاربر واگذارشده نامعتبر است')

// Filter activities based on assigned tickets
let ticketWhere = {};
if (req.query.assignedToUserId) {
  ticketWhere = {
    assigneeId: parseInt(req.query.assignedToUserId as string)
  };
}

// Join with tickets table to filter
prisma.ticketActivity.findMany({
  where: {
    ...where,
    ticket: ticketWhere
  }
})
```

## Mock Data

Mock data شامل فعالیت‌های واقع‌گرایانه برای:
- تیکت قطع برق شهرک صدرا
- درخواست انشعاب جدید ساختمان تجاری  
- نوسان ولتاژ میدان انقلاب

هر تیکت شامل مراحل مختلف:
- واگذاری به مدیر
- تغییر وضعیت‌ها
- افزودن نظرات مدیریتی
- پیوست فایل‌های گزارش
- حل نهایی مشکل

## نحوه توسعه

برای افزودن ویژگی جدید:

1. **نوع فعالیت جدید**: به `actionIcons`, `actionColors` و `actionLabels` اضافه کنید
2. **فیلتر جدید**: به dropdown filters اضافه کنید
3. **نمایش جدید**: Timeline component قابل سفارشی‌سازی است
4. **API جدید**: HistoryService قابل توسعه است

## تست

برای تست کردن:
1. تیکت‌های مختلف با فعالیت‌های مختلف ایجاد کنید
2. فیلترها و جستجو را تست کنید
3. Timeline display را در سایزهای مختلف بررسی کنید
4. Loading و error states را تست کنید
5. Mock data fallback را بررسی کنید

## نکات مهم

- **فیلترینگ خودکار**: صفحه همیشه فقط تاریخچه تیکت‌های واگذار شده را نمایش می‌دهد
- Timeline از جدید به قدیم مرتب شده است
- ScrollArea برای عملکرد بهتر در فعالیت‌های زیاد
- رنگ‌ها و آیکون‌ها consistent با سایر بخش‌های سیستم
- Mock data واقع‌گرایانه برای تست و نمایش
- Error handling جامع برای تمام حالات ممکن

## نمای کاربری

- هدر صفحه نام کاربر فعلی را نمایش می‌دهد
- کارت آبی توضیح می‌دهد که فقط تیکت‌های واگذار شده نمایش داده می‌شوند
- آمار کارت‌ها اطلاعات سریع ارائه می‌دهند
- Timeline واضح و قابل پیگیری است
- در صورت عدم وجود تاریخچه، پیام مناسب نمایش داده می‌شود

## امنیت

- فقط کاربران احراز هویت شده دسترسی دارند
- هر کاربر فقط تاریخچه تیکت‌های واگذار شده به خود را می‌بیند
- API backend تأیید می‌کند که کاربر فقط به تاریخچه مجاز دسترسی داشته باشد