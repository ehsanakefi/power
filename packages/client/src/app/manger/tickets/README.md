# مدیریت تیکت‌ها - Manager Tickets Page

این صفحه برای مدیران طراحی شده است تا بتوانند تیکت‌های مستقیماً واگذار شده به خودشان را مدیریت کنند.

## فیلترینگ خودکار
⚠️ **نکته مهم**: این صفحه فقط تیکت‌هایی را نمایش می‌دهد که مستقیماً به کاربر فعلی واگذار شده‌اند (`assigneeId = currentUser.id`).

## ویژگی‌های اصلی

### 1. نمایش آمار تیکت‌های واگذار شده
- کل تیکت‌های واگذار شده به کاربر
- تیکت‌های در انتظار
- تیکت‌های در حال انجام
- تیکت‌های تکمیل شده

### 1.1. کارت اطلاعاتی
- نمایش کارت آبی با توضیح که فقط تیکت‌های واگذار شده نمایش داده می‌شوند
- نمایش نام کاربر فعلی در هدر صفحه

### 2. فیلترینگ و جستجو
- جستجو در عنوان، شماره تیکت و توضیحات
- فیلتر بر اساس وضعیت:
  - باز
  - واگذار شده
  - در حال انجام
  - در انتظار اطلاعات
  - حل شده
  - بسته شده
  - رد شده
  - ارجاع شده
  - در انتظار

- فیلتر بر اساس اولویت:
  - کم
  - متوسط
  - زیاد
  - فوری
  - بحرانی

- فیلتر بر اساس نوع:
  - شکایت
  - درخواست
  - استعلام
  - فنی
  - قبض
  - اتصال
  - نگهداری

### 3. لیست تیکت‌ها
هر تیکت شامل:
- عنوان و شماره تیکت
- توضیحات (خلاصه)
- اطلاعات مشتری (نام، تلفن)
- تاریخ ایجاد
- وضعیت با رنگ‌بندی
- اولویت
- نوع
- تعداد فایل‌های پیوست
- امکان تغییر وضعیت مستقیم

### 4. جزئیات تیکت
با کلیک روی هر تیکت، پنجره‌ای باز می‌شود که شامل:

#### اطلاعات تیکت:
- عنوان کامل
- توضیحات کامل
- وضعیت فعلی
- اولویت
- نوع
- تاریخ ایجاد و آخرین بروزرسانی
- برچسب‌ها (در صورت وجود)

#### اطلاعات مشتری:
- نام
- شماره تلفن
- ایمیل (در صورت وجود)
- آدرس (در صورت وجود)
- شماره کنتور (در صورت وجود)
- شماره حساب (در صورت وجود)

#### مدیریت وضعیت:
- تغییر وضعیت تیکت با dropdown

#### نظرات و گزارشات:
- مشاهده نظرات قبلی
- افزودن نظر جدید
- نمایش نام کاربر و تاریخ هر نظر

### 5. صفحه‌بندی
- نمایش 10 تیکت در هر صفحه
- دکمه‌های انتقال بین صفحات
- نمایش شماره صفحه فعلی و کل صفحات

## استفاده از API

این صفحه از APIهای زیر استفاده می‌کند:
- `getUserProfile()` - دریافت اطلاعات کاربر فعلی
- `getTickets({ assigneeId: currentUser.id })` - دریافت تیکت‌های واگذار شده با فیلتر خودکار
- `ticketsApi.updateStatus()` - بروزرسانی وضعیت تیکت
- `getTicketComments()` - دریافت نظرات تیکت
- `addTicketComment()` - افزودن نظر جدید

### فیلتر خودکار assigneeId
صفحه به صورت خودکار پارامتر `assigneeId: currentUser.id` را به درخواست API اضافه می‌کند تا فقط تیکت‌های واگذار شده به کاربر فعلی دریافت شوند.

## رنگ‌بندی وضعیت‌ها

- **باز**: آبی
- **واگذار شده**: زرد
- **در حال انجام**: نارنجی
- **در انتظار اطلاعات**: بنفش
- **حل شده**: سبز
- **بسته شده**: خاکستری
- **رد شده**: قرمز
- **ارجاع شده**: بنفش تیره
- **در انتظار**: خاکستری روشن

## رنگ‌بندی اولویت‌ها

- **کم**: سبز
- **متوسط**: زرد
- **زیاد**: نارنجی
- **فوری**: قرمز
- **بحرانی**: قرمز تیره

## ویژگی‌های تکنیکی

### State Management
- استفاده از React Hooks برای مدیریت state
- مدیریت `currentUser` برای فیلترینگ خودکار
- Debounced search برای بهینه‌سازی جستجو
- Loading states برای UX بهتر و انتظار بارگذاری پروفایل کاربر

### Responsive Design
- طراحی واکنش‌گرا برای موبایل و دسکتاپ
- Grid responsive برای فیلترها
- Dialog responsive برای جزئیات تیکت

### Error Handling
- Fallback به mock data در صورت خطا در API
- Mock data به صورت خودکار به کاربر فعلی واگذار می‌شود
- نمایش پیام‌های خطا با toast
- مدیریت حالات loading و error
- اگر پروفایل کاربر بارگذاری نشود، صفحه در حالت loading باقی می‌ماند

### Accessibility
- پشتیبانی از RTL
- کیبورد navigation
- ARIA labels مناسب
- رنگ‌بندی قابل تشخیص

## نحوه توسعه

برای افزودن ویژگی جدید:

1. **فیلتر جدید**: به arrays فیلتر در کامپوننت اضافه کنید
2. **وضعیت جدید**: به `statusColors` و `getStatusLabel` اضافه کنید
3. **فیلد جدید**: به interface `CustomerTicket` اضافه کنید
4. **عمل جدید**: handler جدید تعریف کنید و به UI اضافه کنید

## تست

برای تست کردن:
1. تیکت‌های مختلف با وضعیت‌های مختلف ایجاد کنید
2. فیلترها را تست کنید
3. جستجو را با کلمات مختلف تست کنید
4. عملیات تغییر وضعیت را تست کنید
5. افزودن نظر را تست کنید

## نکات مهم

- **فیلترینگ خودکار**: صفحه همیشه فقط تیکت‌های واگذار شده به کاربر فعلی را نمایش می‌دهد
- همیشه از debounced search استفاده شود
- وضعیت‌ها به صورت consistent در کل سیستم باشند
- رنگ‌ها accessible باشند
- Loading states نمایش داده شوند
- Error handling مناسب پیاده شود
- در صورت عدم دسترسی به API، mock data به کاربر فعلی واگذار می‌شود

## مسیر API Backend

در فایل `power/packages/server/src/routes/tickets.ts` پارامتر `assigneeId` اضافه شده است:

```javascript
const assigneeId = req.query.assigneeId ? parseInt(req.query.assigneeId as string) : undefined;

const filters = {
  // ... other filters
  ...(assigneeId && { assigneeId }),
};
```

## نمای کاربری

- هدر صفحه نام کاربر فعلی را نمایش می‌دهد
- کارت آبی توضیح می‌دهد که فقط تیکت‌های واگذار شده نمایش داده می‌شوند
- در صورت عدم وجود تیکت، پیام مناسب نمایش داده می‌شود